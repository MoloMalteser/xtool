build-mac:
  runs-on: macos-26
  permissions:
    contents: write
  steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        working-directory: macOS
        bundler-cache: true

    - name: Install XcodeGen
      run: brew install xcodegen

    - name: Build
      env:
        APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}
        APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
        APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY }}
        IDENTITY_P12: ${{ secrets.IDENTITY_P12 }}
        DEVELOPMENT_TEAM: ${{ secrets.DEVELOPMENT_TEAM }}
        XTOOL_VERSION: ${{ github.ref_name }}
      run: |
        cd macOS
        bundle exec fastlane package

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: xtool-mac
        path: |
          macOS/Build/Output/xtool.app.zip
          macOS/Build/Output/xtool.app.dSYM.zip
